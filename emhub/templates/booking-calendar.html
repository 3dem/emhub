

<div class="container-fluid  dashboard-content">
    <!-- Header -->
    {% set title = "Booking Calendar" %}
    {% include 'include_header.html' %}

    <!-- ============================================================== -->
    <!-- events calendar -->
    <!-- ============================================================== -->
    <div class="row">
        <div class="col-xl-12 col-lg-12 col-md-12 col-sm-12 col-12">
            <div class="card">
                <div class="card-body">
                    <div class='row'>
                       <div class="col-2">

                           <div id="booking-type">
                            {% for r in resources %}
                               <div class="row justify-content-start" style="margin-top: 10px;">

<!--                                   <div class="col-auto text-left mr-0 pr-0">-->
<!--                                       <label class="custom-control custom-checkbox" style="margin-left: 5px;">-->
<!--                                            <input type="checkbox" checked="" class="custom-control-input"  data-resource-id="{{ r['id'] }}" onclick="filterBookingsByResource(this)"><span class="custom-control-label"></span>-->
<!--                                        </label>-->
<!--                                   </div>-->
                                   <div class="col-auto text-left">
                                       <h4 style="margin-left: 10px"> {{ r['name'] }}</h4>
                                   </div>

                                   <div class="col text-right">
                                       <div style="background-color: {{ r['color'] }}; width: 30px; height: 30px; float: right; margin-right: 10px">
                                        <label style="margin-top: 7px; margin-right: 7px">
                                            <input type="checkbox" checked="" data-resource-id="{{ r['id'] }}" onclick="filterBookingsByResource(this)">
                                        </label>
                                       </div>
                                   </div>
<!--                                   <div class="col-4 text-right"  style="margin: 2px">-->

<!--                                       <div class="switch-button switch-button-xs" >-->
<!--                                           <input type="checkbox" checked="" name="switch{{r['id']}}" id="switch{{r['id']}}">-->
<!--                                           <span><label for="switch{{r['id']}}"></label></span>-->
<!--                                        </div>-->


<!--                                   </div>-->
                               </div>

                                <div class="row align-top" style="margin: -15px 0 0 25px">
                                    <label class="custom-control custom-radio custom-control-inline">
                                        <input type="radio" name="radio-inline" class="custom-control-input"  data-booking-type="booking" data-resource-id="{{ r['id'] }}" onclick="selectResource(this)"><span class="custom-control-label">Book</span>
                                    </label>
                                    {% if current_user.is_manager %}
                                    <label class="custom-control custom-radio custom-control-inline is-invalid">
                                        <input type="radio" name="radio-inline" class="custom-control-input"  data-booking-type="downtime"   data-resource-id="{{ r['id'] }}" onclick="selectResource(this)"><span class="custom-control-label">Downtime</span>
                                    </label>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        </div>

                       </div>
                        <div class="col-9">
                        <div id='booking-calendar'></div>
                    </div>
                        <div style='clear:both'></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- ============================================================== -->
    <!-- end events calendar -->
    <!-- ============================================================== -->
    </div>

<!-- Modal -->
<div class="modal" id="message-modal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="message-title">Message Title  (REPLACE ME) </h3>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body" id="message-body"> Message Body (REPLACE ME) </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary"  data-dismiss="modal">Ok</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal -->
<div class="modal fade" id="booking-modal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-xl" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="booking-modal-title"> TITLE </h3>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="row">
            <!-- ============================================================== -->
            <!-- Booking Form -->
            <!-- ============================================================== -->
            <div class="col-xl-12 col-lg-12 col-md-12 col-sm-12 col-12">
                <form id="validationform" data-parsley-validate="" novalidate="">

                    <!-- Title Row -->
                    <div class="form-group row">
                        <label class="col-12 col-sm-3 col-form-label text-sm-right">Owner</label>
                        <div class="col-12 col-sm-8 col-lg-6">
                            <input type="text" required="" placeholder="Owner" id="booking-owner" class="form-control">
                        </div>
                    </div>

                    <!-- Title Row -->
                    <div class="form-group row">
                        <label class="col-12 col-sm-3 col-form-label text-sm-right">Title</label>
                        <div class="col-12 col-sm-8 col-lg-6">
                            <input type="text" required="" placeholder="Type something" id="booking-title" class="form-control">
                        </div>
                    </div>

                    <!-- Date Start Row -->
                    <div class="form-group row">
                        <label class="col-12 col-sm-3 col-form-label text-sm-right">Start</label>
                        <div class="col-sm-4 col-lg-3 mb-3 mb-sm-0">
                            <input class="form-control" type="text" id="booking-start-date" value="" />
                        </div>
                        <div class="col-sm-4 col-lg-3">
                            <input class="form-control" type="text" id="booking-start-time" value="09:00" />
                        </div>

                    </div>

                    <!-- Date End Form -->
                    <div class="form-group row">
                        <label class="col-12 col-sm-3 col-form-label text-sm-right">End</label>
                        <div class="col-sm-4 col-lg-3 mb-3 mb-sm-0">
                            <input class="form-control" type="text" id="booking-end-date" value="" />
                        </div>
                        <div class="col-sm-4 col-lg-3">
                            <input class="form-control" type="text" id="booking-end-time" value="23:59" />
                        </div>

                    </div>

                    <!-- Booking Type Row -->
                   <div class="form-group row">
                        <label class="col-sm-3 col-form-label text-sm-right">Booking Type</label>
                        <div class="col-sm-6">
                            <div class="custom-controls-stacked">
                                <label class="custom-control custom-radio custom-control-inline">
                                    <input type="radio" name="radio-inline" checked="" class="custom-control-input"><span class="custom-control-label">Booking </span>
                                </label>
                                <label class="custom-control custom-radio custom-control-inline">
                                    <input type="radio" name="radio-inline" class="custom-control-input"><span class="custom-control-label">Slot</span>
                                </label>
                                <label class="custom-control custom-radio custom-control-inline">
                                    <input type="radio" name="radio-inline" class="custom-control-input"><span class="custom-control-label">Downtime</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="form-group row">
                        <label class="col-12 col-sm-3 col-form-label text-sm-right">Description (Optional)</label>
                        <div class="col-12 col-sm-8 col-lg-6">
                            <textarea required="" class="form-control" id="booking-description"></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <!-- ============================================================== -->
            <!-- end Booking Form -->
            <!-- ============================================================== -->
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary">Submit</button>
      </div>
    </div>
  </div>
</div>


<!-- javascript  -->
<script>
    var events;
    var calendar;
    var bookings;
    var resources;
    var selected_resource = null;
    var current_user_json = null;
    var created_event = null;

(function(window, document, $, undefined) {
    "use strict";

   /* initialize the external events
  -----------------------------------------------------------------*/

    var Calendar = FullCalendar.Calendar;
    var Draggable = FullCalendarInteraction.Draggable;

    var containerEl = document.getElementById('booking-type');
    var calendarEl = document.getElementById('booking-calendar');

    // initialize the external events
    // -----------------------------------------------------------------

    var userName = "{{current_user.name}}";

    new Draggable(containerEl, {
      itemSelector: '.fc-event',
      eventData: function(eventEl) {
          // var propValue;
          //   for(var propName in eventEl) {
          //       propValue = eventEl[propName]
          //
          //       console.log(propName, '->', propValue);
          //   }
          var suffix;
          if (eventEl.innerText == 'Downtime')
              suffix = 'Downtime';
          else
              suffix = userName;

          console.log('id: ', eventEl.dataset['rid'])

        return {
          title: eventEl.dataset['rname'] + '(' + suffix + ')',
          textColor: 'white',
          color: eventEl.dataset["color"],
          extendedProps: {resource_id: eventEl.dataset['rid']}
            //duration: {days: 2}
        };
      }
    });

    resources = {{ resources|tojson }};
    bookings = {{ bookings|tojson }} ;
    current_user_json = {{ current_user_json|tojson }}

    calendar = new Calendar(calendarEl, {
        plugins: [ 'interaction', 'dayGrid', 'timeGrid' ],
        header: {
          left: 'prev,next today',
          center: 'title',
          right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        editable: true,
        droppable: true, // this allows things to be dropped onto the calendar
        selectable: true, // allows to select dates
        // drop: function(info) {
        //   // is the "remove after drop" checkbox checked?
        //   if (checkbox.checked) {
        //     // if so, remove the element from the "Draggable Events" list
        //     info.draggedEl.parentNode.removeChild(info.draggedEl);
        //   }
        // }
        events: bookings,
        eventReceive: function(info) {
            //info.event.setProp('title', 'Booking of ' + userName)
       },
        eventAllow: function(dropInfo, draggedEvent) {
            var resource_id = draggedEvent.extendedProps['resource_id'];

            if (resource_id == 1) {
            //return dropInfo.start < new Date(2016, 0, 1); // a boolean
              return false;
            }
            else {
               return true;
            }
        },
        selectAllow: function(info) {
            return true;
        },
        // dateClick: function(info) {
        //     alert('clicked ' + info.dateStr);
        // },
        select: function(info) {
            showBooking(info.start, info.end);
        }
  });

  events = calendar.getEvents();
  calendar.render();

})(window, document, window.jQuery);


/* Helper function to pad dates */
function pad(n) {
    return n < 10 ? '0' + n : n;
}

/* Get date string in YYYY-MM-DD format */
function dateStr(date) {
    return date.getFullYear() + '-' + pad(date.getMonth() + 1) + "-" + pad(date.getDate());
}

/* Function to show the modal */
function showMessage(title, msg) {
    $('#message-title').html(title);
    $('#message-body').html(msg);
    $('#message-modal').modal('show')
}

/* Function to show the modal */
function showBooking(startDate, endDate) {
    if (selected_resource == null) {
        showMessage("ERROR: Select Resource for Booking",
                    "Please select the result (and booking type) from the " +
                    "left panel before selecting dates. ")
    }
    else {
        //console.log("A new date selection was made: " + start.format('YYYY-MM-DD') + ' to ' + end.format('YYYY-MM-DD'));
        var startStr = dateStr(startDate);
        // Remove one day since endDate is exclusive in FullCalendar
        endDate.setDate(endDate.getDate() - 1);
        var endStr = dateStr(endDate);

        $('#booking-modal-title').html('Create Booking - ' + selected_resource.name);
        $('#booking-title').focus();

        $('#booking-owner').val(current_user_json.name);
        $('#booking-owner').prop('readonly', true);

        $('#booking-start-date').val(startStr);
        $('#booking-start-time').val('09:00');
        $('#booking-end-date').val(endStr);
        $('#booking-end-time').val('23:59');

        $('#booking-modal').modal('show');
    }
}

function filterBookingsByResource(input) {
    const inputId = input.dataset.resourceId;
    // console.log("filtering by id: ", inputId);
    // console.log("        checked: ", input.checked);

    for (var event of events) {
        // console.log("Event: ", event.title);
        // console.log("   resource:", event.extendedProps.resource_id);

        if (event.extendedProps.resource_id == inputId){
            if (input.checked)
                calendar.addEvent(event);
            else
                event.remove();
        }
    }
}

/** This function is called when a different resource is changed. */
function selectResource(radio) {
    const resourceId = radio.dataset.resourceId;
    selected_resource = null;
    for (var r of resources) {
        if (r.id == resourceId) {
            selected_resource = r;
            break;
        }
    }
}

function create_booking() {

    var ajaxContent = $.ajax({
        url: "{{ url_for('create_booking') }}",
        type: "POST",
        data: {content_id: content_id, session_id: session_id},
        dataType: "html"
    });

    ajaxContent.done(function(html) {
        $("#main-content").html(html);
    });

    ajaxContent.fail(function(jqXHR, textStatus) {
        alert( "Request failed: " + textStatus );
    });
}

</script>