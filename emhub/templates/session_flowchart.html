
<style>
    .workflow-canvas {
        width: 100%;
        height: 700px;
        border: 1px solid lightgray;
        {#margin-bottom: 15px;#}
        background:
          linear-gradient(90deg, #f0f0f0 21px, transparent 1%) center,
          linear-gradient(#f0f0f0 21px, transparent 1%) center, #646464;
           background-size: 22px 22px;
      }

    .logs_editor {
        position: relative;
        width: 100%;
        height: 350px;
    }

</style>


<div class="container-fluid dashboard-content">
    <!-- Header -->
    {% set title = "Session Workflow" %}
    {% set navigation = [('Sessions', url_for_content('sessions_list')), (session.name, '')] %}
    {% include 'include_header.html' %}

    <div class="card h-100">
        <div class="card-body">
            <div class="row p-0">
                <div class="col-6 p-2">
                    <div id="session_flowchart" class="col-12 workflow-canvas"></div>
                    <div id="session_logs" class="col-12 mt-3"  style="height: 400px">

                        <div class="pills-outline">
                            <ul class="nav nav-pills mb-2" id="logs-tab" role="tablist">
                                 <li class="nav-item">
                                    <a class="nav-link active" id="stdout-tab" data-toggle="pill" href="#pills-stdout" role="tab" aria-controls="stdout" aria-selected="true">stdout</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" id="stderr-tab" data-toggle="pill" href="#pills-stderr" role="tab" aria-controls="stderr" aria-selected="false">stderr</a>
                                </li>
                            </ul>

                            <div class="tab-content m-0 p-0" id="logs-tabContent">
                                <div class="tab-pane fade show active" id="pills-stdout" role="tabpanel" aria-labelledby="stdout-tab">

                                    <div id="stdout-editor" class="logs_editor"></div>

                                </div>

                                <div class="tab-pane fade" id="pills-stderr" role="tabpanel" aria-labelledby="stderr-tab">

                                    <div id="stderr-editor" class="logs_editor"></div>

                                </div>
                            </div>
                        </div>



                    </div>
                </div>
                <div class="col-3">
                        <h3 class="col-12">Parameters</h3>
                        <div id="run_general_container" class="col-12">
                             {% include "session_flowchart_form.html" %}
                        </div>
                        <div id="run_form_container" class="col-12">

                        </div>



                </div>

                <div id="session_params" class="col-3">
                    <h3 class="col-12">Outputs</h3>
                    <div id="json-editor" class="editor-json-black"></div>

                </div>
            </div>
        </div>
    </div>

</div>


<script>
    var selected_node = null;
    var workflow = {{ workflow|tojson }};
    var stdoutEditor, stderrEditor, jsonEditor;
    var session_id = {{ session.id }};


    (function(window, document, $, undefined) {
        "use strict";
        $(function() {
            var container = document.getElementById("session_flowchart");
            var network = createNetwork(container, workflow);

            network.on("click", clickOnCanvas);

            // Create stdoutEditor
            stdoutEditor = ace.edit("stdout-editor");
            stdoutEditor.setTheme("ace/theme/monokai");

            stderrEditor = ace.edit("stderr-editor");
            stderrEditor.setTheme("ace/theme/monokai");

            jsonEditor = ace.edit("json-editor")
            jsonEditor.session.setMode("ace/mode/json");

        });
    })(window, document, window.jQuery);

    function clickOnCanvas(params){
        var  nodeId = params.nodes[0];
        selected_node = null;

        // find node with  that id
          for (var i = 0;  i < workflow.length; i++){
              var prot = workflow[i];
              if (prot.id == nodeId) {
                  selected_node = prot;
                  break;
              }
          }

          stdoutEditor.setValue('');
          stderrEditor.setValue('');
          jsonEditor.setValue('');

          loadRun(selected_node.id, ['form', 'json']);
          loadRun(selected_node.id, ['stdout']);
          loadRun(selected_node.id, ['stderr']);
    }

    function loadRun(runId, output){
        var reqRun = $.ajax({
            url: "{{ url_for('api.get_session_run') }}",
            type: "POST",
            contentType: 'application/json; charset=utf-8',
            data: JSON.stringify({attrs:
                    {runId : runId,
                     sessionId: session_id,
                     output: output
                }}),
            dataType: "json"
        });

        reqRun.done(function(data) {
            console.log(data);

            var run_data = data['run'];

            //alert(JSON.stringify(data));
            if ('json' in run_data) {
                var runDict = run_data['json']
                jsonEditor.setValue(JSON.stringify(run_data, null, 4));
            }

            if ('form' in run_data) {
                //jsonEditor.setValue(JSON.stringify(run_data['form'], null, 4));
                form_create(run_data['form'], run_data['json']['values'], 'run_form_container')
            }

            if ('stdout' in run_data)
                stdoutEditor.setValue(run_data['stdout'])

            if ('stderr' in run_data)
                stderrEditor.setValue(run_data['stderr'])
        });

        reqRun.fail(function(jqXHR, textStatus) {
          alert( "Run request failed: " + textStatus );
        });
    }


</script>